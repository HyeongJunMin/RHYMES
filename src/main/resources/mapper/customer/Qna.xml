<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Qna">
	<!-- qnalist -->
	<select id="getQnaList" parameterType="com.rhymes.app.customer.model.CustomerParam"  resultType="com.rhymes.app.customer.model.QnaDto">
       SELECT SEQ, ID, CATEGORY,REF,STEP,DEPTH,TITLE,CONTENT, WDATE, ORDERNO, FILENAME
      FROM (SELECT ROW_NUMBER()OVER(ORDER BY REF DESC, STEP ASC)AS RNUM,
					SEQ, ID, CATEGORY,REF,STEP,DEPTH,TITLE,CONTENT, WDATE, ORDERNO, FILENAME
					FROM QNA
					WHERE 1=1  
					)A
			WHERE RNUM BETWEEN ${start} AND ${end}	
			ORDER BY REF DESC, STEP ASC
    </select>
	<select id="getQnaCount" parameterType="com.rhymes.app.customer.model.CustomerParam"
		resultType="java.lang.Integer">
		SELECT IFNULL(COUNT(*), 0)AS CNT
		FROM QNA
	</select>

	<!-- qna detail -->
    <select id="getQnaDetail" parameterType="java.lang.Integer" resultType="com.rhymes.app.customer.model.QnaDto">
       SELECT * 
       FROM QNA
       WHERE SEQ = #{seq}
    </select>
    
    <!-- qna 올리기 -->
    <insert id="QnaUpload" parameterType="com.rhymes.app.customer.model.QnaDto">
	INSERT INTO QNA(ID, CATEGORY,REF,STEP,DEPTH,TITLE,CONTENT, WDATE, ORDERNO, FILENAME)
	VALUES(#{id}, #{category},(SELECT IFNULL(MAX(REF), 0)+1 FROM QNA ALIAS_FOR_SUBQUERY),0,0, #{title}, #{content}, NOW(), #{orderno}, #{filename})
	</insert>
	
	<!-- qna 수정 -->
    <update id="QnaUpdateAf" parameterType="com.rhymes.app.customer.model.QnaDto">
	UPDATE QNA
	SET CATEGORY=#{category}, TITLE=#{title}, CONTENT=#{content}, FILENAME=#{filename}
	WHERE SEQ=#{seq}
	</update>
	
	<!-- qna 삭제 -->
	<delete id="QnaDelete" parameterType="java.lang.Integer">
	DELETE FROM QNA
	WHERE SEQ=#{seq}
	</delete>
	
	<!-- qna 답글 -->
	
	
	<update id="QnaAnswer" parameterType="com.rhymes.app.customer.model.QnaDto">
	UPDATE QNA
		SET STEP = (STEP+1)     
			WHERE REF= #{ref}
			AND STEP> #{step}
	</update>
	<insert id="QnaAnswerAf" parameterType="com.rhymes.app.customer.model.QnaDto">
	     INSERT INTO QNA(ID, CATEGORY,REF,STEP,DEPTH,
	     				TITLE,CONTENT, WDATE, ORDERNO, FILENAME)
	     VALUES(#{id},#{category}, 
	     				#{ref},
	     				#{step}+1, 
	     				#{depth}+1,
	     				#{title},#{content},NOW(), #{orderno}, #{filename})
	</insert>
	
	
	<!-- 
	<update id="QnaAnswer" parameterType="com.rhymes.app.customer.model.QnaDto">
	UPDATE QNA
		SET STEP = (STEP+1)     
			WHERE REF= (SELECT REF FROM QNA WHERE SEQ=#{seq})
			AND STEP> (SELECT STEP FROM QNA WHERE SEQ=#{seq})
	</update>
	<insert id="QnaAnswerAf" parameterType="com.rhymes.app.customer.model.QnaDto">
	     INSERT INTO QNA(ID, CATEGORY,REF,STEP,DEPTH,
	     				TITLE,CONTENT, WDATE, ORDERNO, FILENAME)
	     VALUES(#{id},#{category}, 
	     				(SELECT REF FROM QNA WHERE SEQ=#{seq}),
	     				(SELECT STEP FROM QNA WHERE SEQ=#{seq})+1, 
	     				(SELECT DEPTH FROM QNA WHERE SEQ=#{seq})+1
	     				#{title},#{content},NOW(), #{orderno}, #{filename})
	</insert>
	 -->
	
</mapper>
