<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="payment">







<!-- 장바구니에서 주문페이지로 갈 때 -->

<!-- 장바구니에서 결제페이지로 주문한 상품정보 가져오기 -->
<select id="getOrder" parameterType="com.rhymes.app.payment.model.OrderDTO"
resultType="com.rhymes.app.payment.model.OrderDTO">
SELECT P.C_NAME, P.P_NAME, P.P_PRICE, P.PHOTO1_FILE, S.STOCK_SEQ
FROM RHY_STORE_PRODUCT P, RHY_STORE_STOCK S
WHERE P.P_SEQ = S.P_SEQ
AND STOCK_SEQ=#{stock_seq}
</select>

<!-- 결제페이지로 적립금 가져오기 매개변수로 받은 ID가 갖는 적립금 중 유효한 적립금 총 합 리턴 -->
<select id="getPoint" resultType="java.lang.Integer" parameterType="java.lang.String">
SELECT 
	SUM(AMOUNT) AS RESULT
FROM RHY_MEM_POINT 
<![CDATA[
	WHERE 
		ID = #{userid }
		AND RDATE >= date_add(now(), interval -12 month) 
	GROUP BY ID
]]>
</select>

<!-- 결제페이지로 쿠폰 가져오기 -->
<select id="getAllCoupon" parameterType="java.lang.String" resultType="com.rhymes.app.member.model.mypage.MemberCouponDTO">
SELECT * 
FROM (
	<![CDATA[
	SELECT 
		@ROWNUM := @ROWNUM +1 AS RNUM, B.SEQ AS SEQ, TITLE, SUB_TITLE, APP_CATE, FUNC, FUNC_NUM, FUNC_MEASURE, USERID, 
		DATE_FORMAT(GDATE,'%Y-%m-%d') AS GDATE, 
		DATE_FORMAT(EXPDATE,'%Y-%m-%d') AS EXPDATE, 
		COUP_CODE,
		(SELECT IF( DATE_FORMAT(B.EXPDATE,'%Y-%m-%d') < CURDATE(), '만료', ISUSED) ) AS ISUSED
	FROM RHY_MEM_COUPON A, RHY_MEM_COUPON_DETAIL B, (SELECT @ROWNUM :=0) C
	WHERE A.SEQ = B.C_SEQ AND USERID = 'mhj' AND VISIBLE=1
	) RESULT
	]]>
</select>

<!-- 검색조건에 맞는 유효한 쿠폰의 총 개수 리턴 -->
<select id="getCountCoupon" parameterType="java.lang.String" resultType="java.lang.Integer">
	<![CDATA[		
	SELECT COUNT(*) AS CNT
	FROM RHY_MEM_COUPON_DETAIL
	WHERE USERID=#{userid} AND DATE_FORMAT(EXPDATE,'%Y-%m-%d') > CURDATE()
	GROUP BY USERID;
]]>
</select>






<!-- 결제페이지에서 결제완료 후 -->

<!-- 주문한 상품수량만큼 재고수량에서 차감한다 -->
<update id="disc_stock_quantity" parameterType="com.rhymes.app.payment.model.PaymentAfDTO">
UPDATE RHY_STORE_STOCK
SET QUANTITY = QUANTITY - ${quantity}
WHERE STOCK_SEQ=#{stock_seq}
</update>

<!-- 적립금 차감한다 -->
<update id="disc_point" parameterType="com.rhymes.app.payment.model.PaymentDTO">

SELECT *
FROM RHY_MEM_POINT
WHERE ID=#{userid}
ORDER BY RDATE ASC
</update>

<!-- 결제내역 저장 -->
<insert id="payment_save" parameterType="com.rhymes.app.payment.model.PaymentDTO">
INSERT INTO RHY_PAYMENT(PAYMENT_CODE, USERID, SEND_NAME, SEND_PHONE, SEND_EMAIL, RECEIVE_NAME,
RECEIVE_PHONE, RECEIVE_POSTNUM, RECEIVE_ADDRESS, PAYMENT_METHOD, PAYMENT_STATUS, DISC_COUPON,
DELIVERY_PRICE, COUPON_CODE, DISC_POINT, DISC_PRODUCT, ADD_POINT, TOTALPRICE, RDATE)
VALUES(#{payment_code}, #{userid}, #{send_name}, #{send_phone}, #{send_email}, #{receive_name},
#{receive_phone}, #{receive_postnum}, #{receive_address}, #{payment_method}, #{payment_status},
#{disc_coupon}, #{delivery_price}, #{coupon_code}, #{disc_point},
#{disc_product}, #{add_point}, #{totalprice}, SYSDATE())
</insert>

<!-- 사용한 쿠폰을 지운다 -->
<delete id="delete_coupon_code" parameterType="com.rhymes.app.payment.model.PaymentDTO">
DELETE FROM RHY_MEM_COUPON_DETAIL
COUP_CODE=#{coupon_code}
</delete>


<!-- 이메일로 결제내역을 보낸다 -->







<!-- 비회원으로 주문내역 있는지 확인 -->
<select id="no_member_confirm" parameterType="com.rhymes.app.payment.model.PaymentDTO"
resultType="java.lang.String">
SELECT SEND_NAME
FROM RHY_PAYMENT
WHERE SEND_NAME=#{send_name } AND PAYMENT_CODE=#{payment_code }
</select>

<!-- 주문내역 조회 -->
<select id="getOrdercheck" resultType="com.rhymes.app.payment.model.PaymentDTO">
SELECT * FROM RHY_PAYMENT
ORDER BY RDATE DESC
</select>

<!-- 주문상세내역 조회 -->
<select id="getOrdercheckDetail" parameterType="java.lang.String" resultType="com.rhymes.app.payment.model.PaymentDTO">
SELECT * FROM RHY_PAYMENT
WHERE PAYMENT_CODE=#{payment_code}
ORDER BY RDATE DESC
</select>

<!-- 배송현황 조회 -->
<select id="getOrdercheckDelivery" parameterType="java.lang.String" resultType="com.rhymes.app.payment.model.DeliveryDTO">
SELECT * FROM RHY_DELIVERY
WHERE payment_code=#{payment_code}
</select>


</mapper>
